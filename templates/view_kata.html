
{% extends "base.html" %}

{% block title %}{{ kata.title }} - ML Katas{% endblock %}

{% block content %}
    <article class="kata-item">
        <h2>{{ kata.title }}</h2>
        <div class="meta">
            
            {{ kata.difficulty }} ({{ kata.completion_time }})
            {% for topic in kata.topics %}
                <span class="topic">{{ topic }}</span>
            {% endfor %}
        </div>
        <div class="meta">
            <span class="creation-date">{{ kata.created_at | humanize_time }} </span><span>by {{ kata.author_display_name }}</span>
        </div>
        <hr>
        <div id="kata-content" data-markdown="{{ kata.content }}">{{ kata.html_content | safe }}</div>
        <hr>
        <div class="kata-actions">
            <span id="upvote-button-{{ kata.id }}"
                  hx-post="{{ url_for('upvote_kata', kata_id=kata.id) }}"
                  hx-target="this"
                  hx-swap="outerHTML"
                  style="display: inline-block;">
                <button type="button" {% if not user %}disabled{% endif %}>
                    {{ "Upvoted" if kata.is_upvoted else "Upvote" }} ({{ kata.upvotes }})
                </button>
            </span>
            <span id="save-button-{{ kata.id }}"
                  hx-post="{{ url_for('save_kata', kata_id=kata.id) }}"
                  hx-target="this"
                  hx-swap="outerHTML"
                  style="display: inline-block;">
                <button type="button" {% if not user %}disabled{% endif %}>
                    {{ "Saved" if kata.is_saved else "Save" }} ({{ kata.saves }})
                </button>
            </span>
            <span id="complete-button-{{ kata.id }}"
                  hx-post="{{ url_for('complete_kata', kata_id=kata.id) }}"
                  hx-target="this"
                  hx-swap="outerHTML"
                  style="display: inline-block;">
                <button type="button" {% if not user %}disabled{% endif %}>
                    {{ "Completed" if kata.is_completed else "Complete" }} ({{ kata.completions }})
                </button>
            </span>
            <span style="display: inline-block;">
                <button type="button" id="copy-markdown-button">Copy Markdown</button>
            </span>
                        {% if user and kata.author_id == user.id %}
            <span style="display: inline-block;">
                <form action="{{ url_for('delete_kata', kata_id=kata.id) }}" method="POST" style="display: inline;">
                    <button type="submit" onclick="return confirm('Are you sure you want to delete this kata?')">Delete</button>
                </form>
            </span>
            {% endif %}
        </div>
    </article>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('pre code').forEach((block) => {
                const button = document.createElement('button');
                button.className = 'copy-code-button';
                button.innerText = 'Copy';
                button.onclick = () => {
                    navigator.clipboard.writeText(block.innerText).then(() => {
                        button.innerText = 'Copied!';
                        setTimeout(() => { button.innerText = 'Copy'; }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                    });
                };

                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';
                wrapper.style.marginBottom = '1em';
                
                block.parentNode.insertBefore(wrapper, block);
                wrapper.appendChild(block);
                wrapper.appendChild(button);
            });

            document.getElementById('copy-markdown-button').addEventListener('click', (e) => {
                const markdownContent = document.getElementById('kata-content').dataset.markdown;
                navigator.clipboard.writeText(markdownContent).then(() => {
                    e.target.innerText = 'Copied!';
                    setTimeout(() => { e.target.innerText = 'Copy Markdown'; }, 2000);
                }).catch(err => {
                    console.error('Failed to copy markdown: ', err);
                });
            });
        });
    </script>
{% endblock %}
